# Миграция создания таблицы пользователей (users)

**Файл:** `20251013143521-create-users.js`  
**Тип:** Sequelize CLI Migration  
**Дата создания:** 13 октября 2025 г., 14:35:21

## Описание

Эта миграция создает основную таблицу `users` для хранения информации о пользователях интернет-магазина книг. Таблица содержит все необходимые поля для аутентификации, авторизации и хранения профильной информации пользователей.

## Структура таблицы

### Основные поля

| Поле             | Тип         | Описание                              | Ограничения                           |
| ---------------- | ----------- | ------------------------------------- | ------------------------------------- |
| `id`             | INTEGER     | Уникальный идентификатор пользователя | PRIMARY KEY, AUTO_INCREMENT, NOT NULL |
| `email`          | STRING(255) | Электронная почта пользователя        | NOT NULL, UNIQUE, email validation    |
| `password_hash`  | STRING(255) | Хеш пароля (bcrypt)                   | NOT NULL                              |
| `first_name`     | STRING(100) | Имя пользователя                      | NULLABLE                              |
| `last_name`      | STRING(100) | Фамилия пользователя                  | NULLABLE                              |
| `orders_history` | JSONB       | История заказов пользователя          | NULLABLE, default: []                 |
| `created_at`     | DATE        | Дата создания записи                  | NOT NULL, default: CURRENT_TIMESTAMP  |
| `updated_at`     | DATE        | Дата последнего обновления            | NOT NULL, default: CURRENT_TIMESTAMP  |

### Подробное описание полей

#### `id` (INTEGER, PRIMARY KEY)

- **Назначение:** Уникальный идентификатор каждого пользователя
- **Особенности:** Автоматическое увеличение (AUTO_INCREMENT)
- **Использование:** Основной ключ для связей с другими таблицами

#### `email` (STRING(255), UNIQUE)

- **Назначение:** Электронная почта для входа в систему
- **Валидация:** Проверка формата email на уровне базы данных
- **Ограничения:** Уникальное значение для каждого пользователя
- **Индексация:** Создается уникальный индекс для быстрого поиска

#### `password_hash` (STRING(255))

- **Назначение:** Хранение зашифрованного пароля
- **Безопасность:** Используется bcrypt для хеширования
- **Примечание:** Никогда не храним пароли в открытом виде

#### `first_name` и `last_name` (STRING(100))

- **Назначение:** Персональная информация пользователя
- **Особенности:** Опциональные поля, могут быть пустыми
- **Использование:** Для персонализации интерфейса и формирования полного имени

#### `orders_history` (JSONB)

- **Назначение:** История всех заказов пользователя
- **Тип данных:** JSONB для эффективного хранения и запросов
- **Структура:** Массив объектов с информацией о заказах
- **По умолчанию:** Пустой массив `[]`

#### Служебные поля (`created_at`, `updated_at`)

- **Назначение:** Аудит изменений записей
- **Автоматизация:** Автоматически устанавливаются при создании/обновлении
- **Использование:** Отслеживание времени регистрации и активности

## Индексы и производительность

### Уникальный индекс на email

```sql
CREATE UNIQUE INDEX users_email_unique_idx ON users (email);
```

**Преимущества:**

- Быстрый поиск пользователя по email при входе в систему
- Гарантия уникальности email адресов
- Оптимизация запросов аутентификации

## Методы миграции

### `up()` - Создание таблицы

1. Создает таблицу `users` со всеми полями
2. Устанавливает ограничения и валидацию
3. Создает уникальный индекс на поле `email`

### `down()` - Откат миграции

1. Полностью удаляет таблицу `users`
2. Автоматически удаляет все связанные индексы

## Связи с другими таблицами

Таблица `users` является основой для:

- **Аутентификация:** Проверка логина и пароля
- **Авторизация:** Определение прав доступа
- **Заказы:** Связь с покупками книг (через `orders_history`)
- **Персонализация:** Настройка пользовательского интерфейса

## Безопасность

### Хранение паролей

- Пароли хешируются с использованием bcrypt
- Соль генерируется автоматически для каждого пароля
- Минимальная сложность пароля проверяется на уровне приложения

### Валидация email

- Проверка формата на уровне базы данных
- Дополнительная валидация в приложении
- Уникальность гарантируется индексом

## Миграционная стратегия

### Применение миграции

```bash
npx sequelize-cli db:migrate
```

### Откат миграции

```bash
npx sequelize-cli db:migrate:undo
```

### Проверка статуса

```bash
npx sequelize-cli db:migrate:status
```

## Примеры использования

### Создание пользователя

```javascript
const user = await User.create({
  email: "user@example.com",
  password_hash: await bcrypt.hash("password", 10),
  first_name: "Иван",
  last_name: "Петров",
});
```

### Поиск по email

```javascript
const user = await User.findOne({
  where: { email: "user@example.com" },
});
```

### Обновление истории заказов

```javascript
await user.update({
  orders_history: [...user.orders_history, newOrder],
});
```

## Соответствие требованиям

- ✅ **Безопасность:** Хеширование паролей, валидация данных
- ✅ **Производительность:** Индексы на критичные поля
- ✅ **Масштабируемость:** JSONB для гибкого хранения данных
- ✅ **Аудит:** Временные метки для отслеживания изменений
- ✅ **Целостность:** Ограничения и валидация на уровне БД
