# üìö –ú–æ–¥–µ–ª—å Book.js - –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üìã –û–±–∑–æ—Ä

–ú–æ–¥–µ–ª—å `Book` –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∫–Ω–∏–≥–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞. –≠—Ç–æ –æ–¥–Ω–∞ –∏–∑ –¥–≤—É—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è - –º–∞–∫—Å–∏–º—É–º 2 —Ç–∞–±–ª–∏—Ü—ã). –ú–æ–¥–µ–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–∞—Ö, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º, —Å–∏—Å—Ç–µ–º—É –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ –∏ –≥–∏–±–∫–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSONB.

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è

| –ü–æ–ª–µ                  | –¢–∏–ø           | –û–ø–∏—Å–∞–Ω–∏–µ              | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è                |
| --------------------- | ------------- | --------------------- | -------------------------- |
| **id**                | INTEGER       | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á        | AUTO_INCREMENT, NOT NULL   |
| **title**             | VARCHAR(255)  | –ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏        | NOT NULL, 1-255 —Å–∏–º–≤–æ–ª–æ–≤   |
| **author**            | VARCHAR(255)  | –ê–≤—Ç–æ—Ä –∫–Ω–∏–≥–∏           | NOT NULL, 1-255 —Å–∏–º–≤–æ–ª–æ–≤   |
| **genre**             | VARCHAR(100)  | –ñ–∞–Ω—Ä –∫–Ω–∏–≥–∏            | NOT NULL, 1-100 —Å–∏–º–≤–æ–ª–æ–≤   |
| **price**             | DECIMAL(10,2) | –¶–µ–Ω–∞ –∫–Ω–∏–≥–∏            | NOT NULL, 0-999999.99      |
| **description**       | TEXT          | –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ       | NULL, –¥–æ 5000 —Å–∏–º–≤–æ–ª–æ–≤     |
| **short_description** | TEXT          | –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ      | NULL, –¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤      |
| **image**             | VARCHAR(255)  | –ò–º—è —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è | NULL, .jpg/.png/.gif/.webp |

### –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–æ–ª—è (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è)

| –ü–æ–ª–µ           | –¢–∏–ø     | –û–ø–∏—Å–∞–Ω–∏–µ             | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                              |
| -------------- | ------- | -------------------- | --------------------------------------- |
| **popularity** | INTEGER | –°—á–µ—Ç—á–∏–∫ –ø–æ–∫—É–ø–æ–∫      | –ó–∞–º–µ—á–∞–Ω–∏–µ 14: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ |
| **stock**      | INTEGER | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ | –ó–∞–º–µ—á–∞–Ω–∏–µ 15: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞–º–∏      |
| **metadata**   | JSONB   | –ì–∏–±–∫–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ    | –ö–∞—Ç–µ–≥–æ—Ä–∏–∏, ISBN, –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ           |

### –°–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è

| –ü–æ–ª–µ           | –¢–∏–ø       | –û–ø–∏—Å–∞–Ω–∏–µ                   |
| -------------- | --------- | -------------------------- |
| **created_at** | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏       |
| **updated_at** | TIMESTAMP | –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

## üß© –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSONB –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–∏–º–µ—Ä metadata:

```json
{
  "categories": ["romance", "foreign", "price-low"],
  "priceCategory": "low",
  "authorType": "foreign",
  "isbn": "978-5-389-12345-1",
  "publisher": "–ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ –ê–°–¢",
  "year": 2023,
  "pages": 450,
  "language": "ru",
  "binding": "–º—è–≥–∫–∏–π –ø–µ—Ä–µ–ø–ª–µ—Ç"
}
```

### –ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è metadata:

- **categories** - –º–∞—Å—Å–∏–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- **priceCategory** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (low/medium/high)
- **authorType** - —Ç–∏–ø –∞–≤—Ç–æ—Ä–∞ (foreign/domestic)
- **isbn** - –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∫–Ω–∏–≥–∏
- **publisher** - –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞
- **year** - –≥–æ–¥ –∏–∑–¥–∞–Ω–∏—è
- **pages** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü

## üîß –ú–µ—Ç–æ–¥—ã —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ (Instance Methods)

### 1. `isAvailable(quantity = 1)`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–Ω–∏–≥–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ

```javascript
const book = await Book.findByPk(1);
console.log(book.isAvailable(2)); // true/false
console.log(book.isAvailable()); // –ø—Ä–æ–≤–µ—Ä–∫–∞ 1 —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `quantity` (number, optional) - —Ç—Ä–µ–±—É–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `boolean` - true –µ—Å–ª–∏ –∫–Ω–∏–≥–∞ –µ—Å—Ç—å –≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ

### 2. `getCategories()`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–ª—É—á–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

```javascript
const book = await Book.findByPk(1);
const categories = book.getCategories();
console.log(categories); // ["romance", "foreign", "price-low"]
```

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `Array<string>` - –º–∞—Å—Å–∏–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤

### 3. `hasCategory(category)`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∫–Ω–∏–≥–∏ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

```javascript
const book = await Book.findByPk(1);
console.log(book.hasCategory("romance")); // true/false
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `category` (string) - –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `boolean` - true –µ—Å–ª–∏ –∫–Ω–∏–≥–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

### 4. `getPriceCategory()`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–Ω–∏–≥–∏

```javascript
const book = await Book.findByPk(1);
console.log(book.getPriceCategory()); // "low", "medium", "high"
```

**–õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:**

- **low** - —Ü–µ–Ω–∞ < 500‚ÇΩ
- **medium** - —Ü–µ–Ω–∞ 500-999‚ÇΩ
- **high** - —Ü–µ–Ω–∞ ‚â• 1000‚ÇΩ

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `string` - —Ü–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è

### 5. `toJSON()`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è API —Å –≤—ã—á–∏—Å–ª—è–µ–º—ã–º–∏ –ø–æ–ª—è–º–∏

```javascript
const book = await Book.findByPk(1);
const json = book.toJSON();

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:
// - categories: –º–∞—Å—Å–∏–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
// - priceCategory: —Ü–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
// - available: boolean –Ω–∞–ª–∏—á–∏–µ –Ω–∞ —Å–∫–ª–∞–¥–µ
```

## üè≠ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã (Static Methods)

### 1. `findAvailable(options = {})`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–∏—Å–∫ –∫–Ω–∏–≥ –≤ –Ω–∞–ª–∏—á–∏–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π

```javascript
// –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
const books = await Book.findAvailable({
  limit: 10,
  offset: 0,
});

// –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
const books = await Book.findAvailable({
  limit: 20,
  offset: 0,
  genre: "–¥–µ—Ç—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞",
  author: "–≠–∫–∑—é–ø–µ—Ä–∏",
  priceMin: 300,
  priceMax: 1000,
  categories: ["romance", "foreign"],
});
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã options:**

- `limit` (number) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20)
- `offset` (number) - —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0)
- `genre` (string) - —Ñ–∏–ª—å—Ç—Ä –ø–æ –∂–∞–Ω—Ä—É (ILIKE –ø–æ–∏—Å–∫)
- `author` (string) - —Ñ–∏–ª—å—Ç—Ä –ø–æ –∞–≤—Ç–æ—Ä—É (ILIKE –ø–æ–∏—Å–∫)
- `priceMin` (number) - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞
- `priceMax` (number) - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞
- `categories` (Array<string>) - —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (JSONB)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `Promise<Array<Book>>` - –º–∞—Å—Å–∏–≤ –∫–Ω–∏–≥, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏

### 2. `findPopular(limit = 10)`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–Ω–∏–≥ –≤ –Ω–∞–ª–∏—á–∏–∏

```javascript
const popularBooks = await Book.findPopular(5);
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `limit` (number) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `Promise<Array<Book>>` - —Ç–æ–ø –∫–Ω–∏–≥ –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏

### 3. `search(query, options = {})`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ –∫–Ω–∏–≥–∞–º

```javascript
// –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º
const results = await Book.search("–ø—Ä–∏–Ω—Ü");

// –ü–æ–∏—Å–∫ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
const results = await Book.search("–ì—ç—Ç—Å–±–∏", {
  limit: 5,
  offset: 0,
  onlyAvailable: false, // –≤–∫–ª—é—á–∏—Ç—å –∫–Ω–∏–≥–∏ –Ω–µ –≤ –Ω–∞–ª–∏—á–∏–∏
});
```

**–ü–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ –ø–æ–ª—è–º:**

- title (–Ω–∞–∑–≤–∞–Ω–∏–µ)
- author (–∞–≤—Ç–æ—Ä)
- genre (–∂–∞–Ω—Ä)
- description (–æ–ø–∏—Å–∞–Ω–∏–µ)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `query` (string) - –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
- `options.limit` (number) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20)
- `options.offset` (number) - —Å–º–µ—â–µ–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0)
- `options.onlyAvailable` (boolean) - —Ç–æ–ª—å–∫–æ –≤ –Ω–∞–ª–∏—á–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true)

### 4. `purchaseBooks(bookId, quantity, transaction = null)`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê—Ç–æ–º–∞—Ä–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ –∫–Ω–∏–≥ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç race conditions

```javascript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
const transaction = await sequelize.transaction();
try {
  const book = await Book.purchaseBooks(1, 2, transaction);
  await transaction.commit();
  console.log(`–ö—É–ø–ª–µ–Ω–æ! –û—Å—Ç–∞–ª–æ—Å—å: ${book.stock}`);
} catch (error) {
  await transaction.rollback();
  console.error("–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏:", error.message);
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
const book = await Book.purchaseBooks(1, 1);
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**

1. –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å—å –∫–Ω–∏–≥–∏ (`LOCK.UPDATE`)
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
3. –ê—Ç–æ–º–∞—Ä–Ω–æ —É–º–µ–Ω—å—à–∞–µ—Ç —Å–∫–ª–∞–¥ –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∫–Ω–∏–≥—É

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `bookId` (number) - ID –∫–Ω–∏–≥–∏
- `quantity` (number) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø–æ–∫—É–ø–∫–∏
- `transaction` (Transaction, optional) - Sequelize —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è

**–ò—Å–∫–ª—é—á–µ–Ω–∏—è:**

- "–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" - –µ—Å–ª–∏ ID –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ" - –µ—Å–ª–∏ quantity > stock

### 5. `getStats()`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É –∫–Ω–∏–≥

```javascript
const stats = await Book.getStats();
console.log(stats);
// {
//   total: 6,           // –≤—Å–µ–≥–æ –∫–Ω–∏–≥
//   available: 5,       // –≤ –Ω–∞–ª–∏—á–∏–∏
//   outOfStock: 1,      // –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å
//   percentage: 83      // –ø—Ä–æ—Ü–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
// }
```

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `Promise<Object>` —Å –ø–æ–ª—è–º–∏:

- `total` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥
- `available` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –≤ –Ω–∞–ª–∏—á–∏–∏
- `outOfStock` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –Ω–µ –≤ –Ω–∞–ª–∏—á–∏–∏
- `percentage` - –ø—Ä–æ—Ü–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (0-100)

## üõ°Ô∏è –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π –º–æ–¥–µ–ª–∏

```javascript
// –ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏
title: {
  validate: {
    notEmpty: { msg: "–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º" },
    len: { args: [1, 255], msg: "–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç 1 –¥–æ 255 —Å–∏–º–≤–æ–ª–æ–≤" }
  }
}

// –¶–µ–Ω–∞
price: {
  validate: {
    isDecimal: { msg: "–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º" },
    min: { args: [0], msg: "–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π" },
    max: { args: [999999.99], msg: "–¶–µ–Ω–∞ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∞—è" }
  }
}

// –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
image: {
  validate: {
    isValidImageName(value) {
      if (value && !/\.(jpg|jpeg|png|gif|webp)$/i.test(value)) {
        throw new Error("–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
      }
    }
  }
}

// –ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å
popularity: {
  validate: {
    isInt: { msg: "–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º" },
    min: { args: [0], msg: "–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π" }
  }
}

// –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
metadata: {
  validate: {
    isValidMetadata(value) {
      if (typeof value !== "object" || Array.isArray(value)) {
        throw new Error("–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º");
      }

      if (value.categories && !Array.isArray(value.categories)) {
        throw new Error("–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º");
      }

      if (value.priceCategory && !["low", "medium", "high"].includes(value.priceCategory)) {
        throw new Error("–ù–µ–≤–µ—Ä–Ω–∞—è —Ü–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è");
      }
    }
  }
}
```

## üìà –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã:

```javascript
indexes: [
  {
    fields: ["popularity"],
    name: "books_popularity_idx", // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏
  },
  {
    fields: ["stock"],
    name: "books_stock_idx", // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –Ω–∞–ª–∏—á–∏—é
  },
  {
    fields: ["genre"],
    name: "books_genre_idx", // –ü–æ–∏—Å–∫ –ø–æ –∂–∞–Ω—Ä—É
  },
  {
    fields: ["author"],
    name: "books_author_idx", // –ü–æ–∏—Å–∫ –ø–æ –∞–≤—Ç–æ—Ä—É
  },
  {
    fields: ["price"],
    name: "books_price_idx", // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ü–µ–Ω–µ
  },
  {
    using: "gin",
    fields: ["metadata"],
    name: "books_metadata_gin_idx", // JSONB –∏–Ω–¥–µ–∫—Å –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  },
];
```

## üîç –ü—Ä–∏–º–µ—Ä—ã SQL –∑–∞–ø—Ä–æ—Å–æ–≤

### 1. –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–Ω–∏–≥–∏ –≤ –Ω–∞–ª–∏—á–∏–∏:

```sql
SELECT * FROM books
WHERE stock > 0
ORDER BY popularity DESC, created_at DESC
LIMIT 10;
```

### 2. –ü–æ–∏—Å–∫ –ø–æ JSONB –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:

```sql
SELECT * FROM books
WHERE metadata @> '{"categories": ["romance"]}'
AND stock > 0;
```

### 3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ü–µ–Ω–µ –∏ –∂–∞–Ω—Ä—É:

```sql
SELECT * FROM books
WHERE stock > 0
AND price BETWEEN 500 AND 1000
AND genre ILIKE '%–¥–µ—Ç—Å–∫–∞—è%'
ORDER BY popularity DESC;
```

### 4. –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫:

```sql
SELECT * FROM books
WHERE (
  title ILIKE '%–ø—Ä–∏–Ω—Ü%' OR
  author ILIKE '%–ø—Ä–∏–Ω—Ü%' OR
  genre ILIKE '%–ø—Ä–∏–Ω—Ü%' OR
  description ILIKE '%–ø—Ä–∏–Ω—Ü%'
)
AND stock > 0
ORDER BY popularity DESC;
```

## üß™ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–Ω–∏–≥–∏:

```javascript
const newBook = await Book.create({
  title: "–ù–æ–≤–∞—è –∫–Ω–∏–≥–∞",
  author: "–ù–æ–≤—ã–π –∞–≤—Ç–æ—Ä",
  genre: "—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞",
  price: 750.0,
  description: "–£–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è...",
  short_description: "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ",
  image: "book-cover.jpg",
  popularity: 0,
  stock: 15,
  metadata: {
    categories: ["sci-fi", "new", "price-medium"],
    priceCategory: "medium",
    isbn: "978-5-123-45678-9",
    publisher: "–ù–æ–≤–æ–µ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ",
    year: 2025,
    pages: 320,
  },
});
```

### –ö–∞—Ç–∞–ª–æ–≥ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π:

```javascript
async function getCatalogPage(page = 1, pageSize = 20, filters = {}) {
  const offset = (page - 1) * pageSize;

  const books = await Book.findAvailable({
    limit: pageSize,
    offset: offset,
    ...filters,
  });

  const total = await Book.count({
    where: { stock: { [Op.gt]: 0 } },
  });

  return {
    books,
    pagination: {
      page,
      pageSize,
      total,
      totalPages: Math.ceil(total / pageSize),
      hasNext: page < Math.ceil(total / pageSize),
      hasPrev: page > 1,
    },
  };
}
```

### –ü–æ–∫—É–ø–∫–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫:

```javascript
async function purchaseBook(bookId, quantity, userId) {
  const transaction = await sequelize.transaction();

  try {
    // 1. –ü–æ–∫—É–ø–∞–µ–º –∫–Ω–∏–≥—É (–∞—Ç–æ–º–∞—Ä–Ω–æ)
    const book = await Book.purchaseBooks(bookId, quantity, transaction);

    // 2. –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = await User.findByPk(userId, { transaction });
    await user.addOrder({
      book_id: bookId,
      title: book.title,
      quantity: quantity,
      price: book.price,
      total: book.price * quantity,
    });

    await transaction.commit();

    return {
      success: true,
      book: book,
      message: `–£—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω–æ ${quantity} —ç–∫–∑. "${book.title}"`,
    };
  } catch (error) {
    await transaction.rollback();

    return {
      success: false,
      error: error.message,
    };
  }
}
```

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** –¥–ª—è purchaseBooks()
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ limit/offset** –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–∞—Ç–∞–ª–æ–≥–æ–≤
3. **–ö–µ—à–∏—Ä—É–π—Ç–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–Ω–∏–≥–∏** –≤ Redis/Memcached
4. **–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã** –¥–ª—è —á–∞—Å—Ç—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
5. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ EXPLAIN ANALYZE** –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

```javascript
// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
const sequelize = new Sequelize(config, {
  logging: (sql, timing) => {
    if (timing > 1000) {
      // –ó–∞–ø—Ä–æ—Å—ã > 1 —Å–µ–∫—É–Ω–¥—ã
      console.warn(`Slow query (${timing}ms):`, sql);
    }
  },
  benchmark: true,
});
```

## üîó –°–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥–µ–ª—è–º–∏

–í –Ω–∞—à–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Å 2 —Ç–∞–±–ª–∏—Ü–∞–º–∏ —Å–≤—è–∑–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ JSONB:

- **User.orders_history** —Å–æ–¥–µ—Ä–∂–∏—Ç book_id –¥–ª—è —Å–≤—è–∑–∏ —Å –∫–Ω–∏–≥–∞–º–∏
- **Book.metadata** –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- –ü—Ä—è–º—ã–µ Sequelize –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è (–ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è)

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ú–æ–¥–µ–ª—å Book –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

‚úÖ **–ü–æ–ª–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∫–∞—Ç–∞–ª–æ–≥–∞** - –ø–æ–∏—Å–∫, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞  
‚úÖ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è, –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏  
‚úÖ **–°–∏—Å—Ç–µ–º—É –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∫—É–ø–æ–∫  
‚úÖ **–ì–∏–±–∫–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ** - JSONB –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –¥–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏  
‚úÖ **–í—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –≤—Å–µ—Ö —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤  
‚úÖ **–ó–∞—â–∏—Ç—É –æ—Ç race conditions** - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏  
‚úÖ **–ü–æ–ª–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ú–æ–¥–µ–ª—å –≥–æ—Ç–æ–≤–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–µ –∫–Ω–∏–≥.
