# Миграция создания таблицы книг (books)

**Файл:** `20251013144458-create-books.js`  
**Тип:** Sequelize CLI Migration  
**Дата создания:** 13 октября 2025 г., 14:44:58

## Описание

Эта миграция создает центральную таблицу `books` для хранения информации о книгах в интернет-магазине. Таблица содержит все необходимые поля для управления каталогом книг, включая товарную информацию, описания, цены и метаданные для аналитики.

## Структура таблицы

### Основные поля

| Поле                | Тип           | Описание                       | Ограничения                           |
| ------------------- | ------------- | ------------------------------ | ------------------------------------- |
| `id`                | INTEGER       | Уникальный идентификатор книги | PRIMARY KEY, AUTO_INCREMENT, NOT NULL |
| `title`             | STRING(255)   | Название книги                 | NOT NULL                              |
| `author`            | STRING(255)   | Автор книги                    | NOT NULL                              |
| `genre`             | STRING(100)   | Жанр книги                     | NOT NULL                              |
| `price`             | DECIMAL(10,2) | Цена книги в рублях            | NOT NULL, min: 0                      |
| `description`       | TEXT          | Полное описание книги          | NULLABLE                              |
| `short_description` | TEXT          | Краткое описание               | NULLABLE                              |
| `image`             | STRING(255)   | Путь к изображению обложки     | NULLABLE                              |
| `popularity`        | INTEGER       | Рейтинг популярности           | NOT NULL, default: 0, min: 0          |
| `stock`             | INTEGER       | Количество в наличии           | NOT NULL, default: 0, min: 0          |
| `metadata`          | JSONB         | Дополнительные метаданные      | NULLABLE, default: {}                 |
| `created_at`        | DATE          | Дата добавления книги          | NOT NULL, default: CURRENT_TIMESTAMP  |
| `updated_at`        | DATE          | Дата последнего обновления     | NOT NULL, default: CURRENT_TIMESTAMP  |

### Подробное описание полей

#### `id` (INTEGER, PRIMARY KEY)

- **Назначение:** Уникальный идентификатор каждой книги
- **Особенности:** Автоматическое увеличение (AUTO_INCREMENT)
- **Использование:** Основной ключ для ссылок в заказах и связях

#### `title` (STRING(255))

- **Назначение:** Название книги
- **Ограничения:** Обязательное поле, максимум 255 символов
- **Использование:** Отображение в каталоге, поиск по названию
- **Примеры:** "Война и мир", "1984", "Маленький принц"

#### `author` (STRING(255))

- **Назначение:** Имя автора книги
- **Ограничения:** Обязательное поле, максимум 255 символов
- **Индексация:** Создается индекс для быстрого поиска по автору
- **Примеры:** "Лев Толстой", "Джордж Оруэлл", "Антуан де Сент-Экзюпери"

#### `genre` (STRING(100))

- **Назначение:** Жанр книги для категоризации
- **Ограничения:** Обязательное поле, максимум 100 символов
- **Индексация:** Создается индекс для фильтрации по жанрам
- **Примеры:** "Фантастика", "Романтика", "Детектив", "Биография"

#### `price` (DECIMAL(10,2))

- **Назначение:** Цена книги в рублях
- **Точность:** 10 цифр общих, 2 после запятой (до 99,999,999.99 ₽)
- **Валидация:** Минимальное значение 0 (бесплатные книги разрешены)
- **Примеры:** 899.99, 1250.00, 0.00

#### `description` (TEXT)

- **Назначение:** Полное описание книги для страницы товара
- **Особенности:** Неограниченная длина, может содержать HTML
- **Использование:** Подробная информация о сюжете, авторе, особенностях

#### `short_description` (TEXT)

- **Назначение:** Краткое описание для карточек в каталоге
- **Рекомендации:** 100-200 символов для оптимального отображения
- **Использование:** Предварительный просмотр в списках книг

#### `image` (STRING(255))

- **Назначение:** Путь к файлу изображения обложки
- **Формат:** Относительный путь от папки public/img/
- **Примеры:** "book1.jpg", "covers/fantasy-001.png"
- **Fallback:** При отсутствии используется placeholder

#### `popularity` (INTEGER)

- **Назначение:** Рейтинг популярности книги
- **Расчет:** Количество покупок, просмотров, рейтинг
- **Индексация:** Создается индекс для сортировки по популярности
- **Использование:** Определение "популярных книг", рекомендации

#### `stock` (INTEGER)

- **Назначение:** Текущее количество книг в наличии
- **Валидация:** Минимальное значение 0
- **Индексация:** Создается индекс для фильтрации доступных книг
- **Автоматизация:** Уменьшается при покупке, увеличивается при поступлении

#### `metadata` (JSONB)

- **Назначение:** Гибкое хранение дополнительной информации
- **Тип данных:** JSONB для эффективных запросов и индексации
- **Структура:** Объект с различными категориями данных
- **По умолчанию:** Пустой объект `{}`

**Примерная структура metadata:**

```json
{
  "categories": ["fantasy", "russian", "price-low"],
  "priceCategory": "low",
  "authorType": "russian",
  "isbn": "978-5-389-12345-1",
  "pageCount": 320,
  "publisher": "Эксмо",
  "publicationYear": 2023,
  "language": "ru",
  "dimensions": "20x13x2",
  "weight": 350
}
```

## Индексы и производительность

### 1. Индекс популярности

```sql
CREATE INDEX books_popularity_idx ON books (popularity);
```

- **Назначение:** Быстрая сортировка по популярности
- **Использование:** Главная страница, рекомендации

### 2. Индекс наличия

```sql
CREATE INDEX books_stock_idx ON books (stock);
```

- **Назначение:** Фильтрация книг в наличии
- **Использование:** Каталог с фильтром "только в наличии"

### 3. Индекс жанров

```sql
CREATE INDEX books_genre_idx ON books (genre);
```

- **Назначение:** Быстрая фильтрация по жанрам
- **Использование:** Фильтры каталога, категории

### 4. Индекс авторов

```sql
CREATE INDEX books_author_idx ON books (author);
```

- **Назначение:** Поиск книг конкретного автора
- **Использование:** Фильтры, страницы авторов

## Методы миграции

### `up()` - Создание таблицы

1. Создает таблицу `books` со всеми полями
2. Устанавливает ограничения и валидацию
3. Создает четыре индекса для оптимизации запросов

### `down()` - Откат миграции

1. Полностью удаляет таблицу `books`
2. Автоматически удаляет все связанные индексы

## Бизнес-логика и использование

### Каталог книг

- **Поиск:** По названию, автору, жанру
- **Фильтрация:** По жанру, цене, наличию
- **Сортировка:** По популярности, цене, дате добавления

### Управление запасами

- **Отслеживание:** Количество в наличии
- **Автоматизация:** Уменьшение при продаже
- **Уведомления:** О заканчивающихся товарах

### Аналитика

- **Популярность:** Отслеживание трендов
- **Категории:** Анализ продаж по жанрам
- **Метаданные:** Дополнительная аналитическая информация

## Связи с другими таблицами

### Прямые связи

- **Заказы:** Книги связаны с заказами пользователей
- **Корзина:** Временное хранение выбранных книг
- **Избранное:** Списки желаемых книг

### Косвенные связи

- **Пользователи:** Через историю покупок
- **Отзывы:** Рейтинги и комментарии к книгам
- **Рекомендации:** Алгоритмы предложений

## Валидация и ограничения

### На уровне базы данных

- `price >= 0` - Цена не может быть отрицательной
- `popularity >= 0` - Популярность не может быть отрицательной
- `stock >= 0` - Количество не может быть отрицательным

### На уровне приложения

- Проверка существования файла изображения
- Валидация ISBN в метаданных
- Ограничения на длину описаний
- Проверка корректности жанра из списка

## Примеры использования

### Создание книги

```javascript
const book = await Book.create({
  title: "Новая книга",
  author: "Известный Автор",
  genre: "Фантастика",
  price: 899.99,
  description: "Захватывающая история...",
  stock: 50,
  popularity: 0,
});
```

### Поиск популярных книг

```javascript
const popularBooks = await Book.findAll({
  where: { stock: { [Op.gt]: 0 } },
  order: [["popularity", "DESC"]],
  limit: 10,
});
```

### Фильтрация по жанру

```javascript
const fantasyBooks = await Book.findAll({
  where: {
    genre: "Фантастика",
    stock: { [Op.gt]: 0 },
  },
  order: [["popularity", "DESC"]],
});
```

### Обновление количества при покупке

```javascript
await book.decrement("stock", { by: quantity });
await book.increment("popularity", { by: 1 });
```

## Миграционная стратегия

### Применение миграции

```bash
npx sequelize-cli db:migrate
```

### Откат миграции

```bash
npx sequelize-cli db:migrate:undo
```

### Проверка структуры

```bash
npx sequelize-cli db:migrate:status
```

## Соответствие требованиям

- ✅ **Производительность:** Оптимальные индексы для всех типов запросов
- ✅ **Гибкость:** JSONB для расширяемых метаданных
- ✅ **Целостность:** Валидация на уровне БД и приложения
- ✅ **Масштабируемость:** Эффективные типы данных и индексы
- ✅ **Бизнес-логика:** Поддержка всех операций интернет-магазина
- ✅ **Аналитика:** Данные для отчетности и рекомендаций
